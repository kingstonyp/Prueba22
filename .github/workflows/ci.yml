name: CI - Tests (improved)

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [11, 17]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: Cache Maven repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-java-${{ matrix.java }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-java-${{ matrix.java }}-
            m2-${{ runner.os }}-java-

      - name: Install Chrome (dependencies)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip fontconfig libnss3 libatk1.0-0 libatk-bridge2.0-0 libx11-xcb1 libxss1 libasound2 libcups2 libxrandr2 libxdamage1 libgbm1 libpango-1.0-0 libpangocairo-1.0-0

      - name: Build & run tests (headless) - try up to 3 times
        env:
          HEADLESS: 'true'
        run: |
          set -e
          n=0
          max=3
          until [ $n -ge $max ]
          do
            echo "Attempt $((n+1))/$max"
            mvn -U -B test && break
            n=$((n+1))
            echo "Test attempt $n failed. Retrying..."
            sleep 2
          done
          if [ $n -ge $max ]; then
            echo "Tests failed after $max attempts"
            exit 1
          fi

      - name: Generate Cucumber HTML report
        run: mvn -U -B verify

      - name: Upload cucumber HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-html-report
          path: target/cucumber-html-reports

      - name: Upload screenshots (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: target/screenshots

      - name: Upload surefire reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      - name: Post summary comment on PR (if PR) [optional]
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = context.payload.pull_request ? "CI completed" : "CI run";
            github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `CI run finished for commit \`${process.env.GITHUB_SHA}\`. See Actions tab for details.`
            })
